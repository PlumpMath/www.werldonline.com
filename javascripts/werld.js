// werld-client-browser - v0.0.0 - 2012-06-26
// http://www.werldonline.com
// Copyright (c) 2012  Murilo Pereira <murilo@murilopereira.com>.
// All rights reserved.
// Licensed MIT.
var Werld={Views:{Base:{}},Models:{Base:{}},Collections:{},containers:{},CONTAINER_NAMES:["terrain","objects","creatures","character","gumps","itemTransfer","gameMessages"],MESSAGES:{STAT_INCREASE:{NAME:"STAT_INCREASE",FONT:'18px "PowellAntique" serif',COLOR:"#66cc00"},STAT_DECREASE:{NAME:"STAT_DECREASE",FONT:'18px "PowellAntique" serif',COLOR:"#66cc00"},SKILL_INCREASE:{NAME:"SKILL_INCREASE",FONT:'18px "PowellAntique" serif',COLOR:"#05b8cc"},SKILL_DECREASE:{NAME:"SKILL_DECREASE",FONT:'18px "PowellAntique" serif',COLOR:"#05b8cc"}},STATES:{INIT:1,SPLASH_SCREEN:2,CHOOSING_NAME:3,GAME_STARTED:4},SKILLS:{WRESTLING:{NAME:"wrestling"},SWORDSMANSHIP:{NAME:"swordsmanship"}},OBJECTS:{ALTAR:{IMAGE:{SRC:"images/objects/altar.png"}}},Config:{AGGRESSIVENESS_RADIUS:6,AGGRESSIVENESS_HANDLER_RATE:2e3,ALTAR_CHARACTER_RESURRECTION_OBSERVER_INTERVAL:1e3,RESPAWN_TIME:6e4,CORPSE_DECAY_TIME:8e4,FRAMES_PER_SECOND:30,MAXIMUM_ATTACK_SPEED:1.25,MAXIMUM_DAMAGE_BONUS_PERCENTAGE:100,MAXIMUM_HIT_CHANCE_PERCENTAGE:100,MESSAGE_LIFE_CYCLE:5e3,MESSAGE_SWEEPER_POLLING_INTERVAL:1e3,PIXELS_PER_TILE:40,PROVOCABILITY:.3,REGENERATION_RATE:1e3,SCREEN_DIMENSIONS:[16,12],STOP_ATTACKING_HANDLER_RATE:500,WORLD_MAP_DIMENSIONS:[50,50]},frameRate:function(){return Math.floor(1e3/Werld.Config.FRAMES_PER_SECOND)},switchState:function(a,b){b||(b={});if(Werld.state===Werld.STATES.INIT)a===Werld.STATES.SPLASH_SCREEN&&(Werld.state=Werld.STATES.SPLASH_SCREEN);else if(Werld.state===Werld.STATES.SPLASH_SCREEN){if(a===Werld.STATES.CHOOSING_NAME){var c=new Werld.Views.CharacterNameInputForm;c.render(),Werld.state=Werld.STATES.CHOOSING_NAME}}else if(Werld.state===Werld.STATES.CHOOSING_NAME){if(a===Werld.STATES.GAME_STARTED){Werld.stage.removeAllChildren(),_(Werld.CONTAINER_NAMES).each(function(a){Werld.containers[a]=new Container});var d=new Werld.Models.Item(Werld.ITEMS.SHORT_SWORD);Werld.character=new Werld.Models.Character(_({id:1,name:b.data.character.name,strength:20,dexterity:20,intelligence:10,swordsmanship:50,items:new Werld.Collections.Items([d]),coordinates:_([Math.floor(Werld.Config.SCREEN_DIMENSIONS[0]/2),Math.floor(Werld.Config.SCREEN_DIMENSIONS[1]/2)]).map(Werld.Utils.Geometry.tilesToPixels)}).extend(Werld.CREATURES.CHARACTER)),Werld.character.equip(d),Werld.game=new Werld.Models.Game({characters:[Werld.character]}),Werld.canvas.characterView=new Werld.Views.Character({model:Werld.character}),Werld.canvas.statusBarView=new Werld.Views.StatusBar({model:Werld.character}),Werld.canvas.backpackView=new Werld.Views.Backpack({model:Werld.character.backpack});var e=new Werld.Models.CreatureSpawner({creature:Werld.CREATURES.SILVER_BAT,tileCoordinates:[4,4],tileRadius:3,numberOfCreatures:3}),f=new Werld.Models.CreatureSpawner({creature:Werld.CREATURES.WHITE_WOLF,tileCoordinates:[15,10],tileRadius:4,numberOfCreatures:2}),g=new Werld.Models.CreatureSpawner({creature:Werld.CREATURES.FIRE_WOLF,tileCoordinates:[15,15],tileRadius:4,numberOfCreatures:2}),h=new Werld.Models.CreatureSpawner({creature:Werld.CREATURES.LEVIATHAN,tileCoordinates:[4,15],tileRadius:4,numberOfCreatures:1}),i=new Werld.Models.CreatureSpawner({creature:Werld.CREATURES.BLUE_DRAGON,tileCoordinates:[4,10],tileRadius:4,numberOfCreatures:1});Werld.creatureSpawners=new Werld.Collections.CreatureSpawners([e,f,g,h,i]),Werld.map=new Werld.Models.Map,Werld.screen=new Werld.Models.Screen({map:Werld.map,character:Werld.character,dimensions:Werld.Config.SCREEN_DIMENSIONS,coordinates:[0,0]}),Werld.canvas.screenView=new Werld.Views.Screen({model:Werld.screen}),Werld.altar=new Werld.Models.Altar(_.extend(Werld.OBJECTS.ALTAR,{coordinates:_([7,8]).map(function(a){return a*Werld.Config.PIXELS_PER_TILE})})),Werld.canvas.altarView=new Werld.Views.Altar({model:Werld.altar}),new Werld.Views.MessageInputFormHandler,new Werld.Views.GameMessages({model:Werld.character,collection:new Werld.Collections.EphemeralMessages(null,{lifetime:7e3}),container:Werld.containers.gameMessages}),Werld.containers.terrain.addChild(Werld.canvas.screenView.container),Werld.containers.objects.addChild(Werld.canvas.altarView.container),Werld.containers.character.addChild(Werld.canvas.characterView.container),Werld.creatureSpawners.activateAll(),Werld.containers.gumps.addChild(Werld.canvas.statusBarView.container),Werld.containers.gumps.addChild(Werld.canvas.backpackView.container),Werld.containers.gumps.screen=Werld.screen,_.chain(Werld.containers).values().each(function(a){Werld.stage.addChild(a)}),Werld.state=Werld.STATES.GAME_STARTED}}else a===Werld.STATES.INIT&&(Werld.state=Werld.STATES.INIT);Werld.Utils.Callback.run(b.callback)},init:function(){$(window).contextmenu(function(a){return!1}),Werld.switchState(Werld.STATES.INIT),Werld.canvas=new Werld.Canvas,Werld.stage=new Stage(Werld.canvas.el),Werld.stage.enableMouseOver(),Ticker.useRAF=!0,Ticker.setFPS(Werld.Config.FRAMES_PER_SECOND);var a=new Stats;a.setMode(0),a.domElement.style.position="absolute",a.domElement.style.left="0px",a.domElement.style.top="0px",document.body.appendChild(a.domElement),Ticker.addListener({tick:function(){a.begin(),Werld.stage.tick(),a.end()}});var b=new Werld.Views.SplashScreen;Werld.stage.addChild(b.container),Werld.switchState(Werld.STATES.SPLASH_SCREEN)}};$(Werld.init),Werld.GUMPS={BACKPACK:{name:"Backpack"},LOOT_CONTAINER:{name:"Loot container"}},Werld.ITEM_TYPES={WEAPON:{NAME:"weapon"}},Werld.ITEMS={SHORT_SWORD:{name:"Short Sword",skill:Werld.SKILLS.SWORDSMANSHIP.NAME,type:Werld.ITEM_TYPES.WEAPON.NAME,speed:5,baseDamageRange:[2,5],equipable:!0},GOLD:{name:"Gold",stackable:!0}},Werld.IMAGES={},Werld.IMAGES[Werld.GUMPS.BACKPACK.name]={SRC:"images/backpack.png"},Werld.IMAGES[Werld.GUMPS.LOOT_CONTAINER.name]={SRC:"images/loot_container.png"},Werld.IMAGES[Werld.ITEMS.GOLD.name]={SRC:"images/gold.png"},Werld.IMAGES[Werld.ITEMS.SHORT_SWORD.name]={SRC:"images/short_sword.png"},Werld.Collections.Creatures=Backbone.Collection.extend({model:Werld.Models.Creature}),Werld.Collections.Threateners=Werld.Collections.Creatures.extend({update:function(a){var b=new Werld.Collections.Creatures(a),c=this;this.each(function(a){b.get(a.id)||c.remove(a)}),b.each(function(a){c.get(a.id)||c.add(a)})}}),Werld.Collections.Messages=Backbone.Collection.extend(),Werld.Collections.EphemeralMessages=Werld.Collections.Messages.extend({initialize:function(a,b){if(!b.lifetime)throw new Error("Must be initialized with a lifetime");this.lifetime=b.lifetime,this.on("add",this.maybeInstallSweeper),this.on("remove",this.maybeUninstallSweeper)},maybeInstallSweeper:function(a){this.length===1&&Werld.Utils.Interval.install({sweeper:this.lifetime},this)},maybeUninstallSweeper:function(a){this.isEmpty()&&Werld.Utils.Interval.uninstall({sweeper:this.lifetime},this)},sweeper:function(){if(this.isEmpty())return;this.remove(this.filter(_(function(a){return Date.now()-a.get("created_at")>this.lifetime}).bind(this)))}}),Werld.Models.Map=Backbone.Model.extend({initialize:function(){var a=[];for(var b=0;b<Werld.Config.WORLD_MAP_DIMENSIONS[0];b++){a[b]=[];for(var c=0;c<Werld.Config.WORLD_MAP_DIMENSIONS[1];c++)a[b][c]=new Werld.Models.Tile({type:Math.random()>.75?"dirt":"grass",coordinates:_([b,c]).map(Werld.Utils.Geometry.tilesToPixels)})}this.set({tiles:a,dimensions:[a.length,a[0].length]})}}),Werld.Models.CreatureSpawner=Backbone.Model.extend({defaults:{respawnTime:Werld.Config.RESPAWN_TIME,corpseDecayTime:Werld.Config.CORPSE_DECAY_TIME,randomMovementWithinSpawnAreaTimeRange:[5e3,1e4]},initialize:function(){_.bindAll(this),this.spawnAreaCircle=new Werld.Utils.Circle({center:this.get("tileCoordinates"),radius:this.get("tileRadius"),measurement:"tiles"}),this.creatures=new Werld.Collections.Creatures;var a=this;this.creatures.on("add",function(a){var b=new Werld.Views.Creature({model:a});Werld.containers.creatures.addChild(b.container)}),this.creatures.on("add",function(b){a.spawnAreaMovementHandler(b)})},spawnAreaMovementHandler:function(a){var b=this.get("randomMovementWithinSpawnAreaTimeRange"),c=Werld.Utils.Math.randomIntegerBetween(b),d=this;_(function(){if(a.dead())return;if(a.state()===a.states.idle){var b=d.randomAdjacentTilePointWithinSpawnArea(a);b?a.move(b):a.move(d.adjacentTilePointCloserToSpawnArea(a))}d.spawnAreaMovementHandler(a)}).delay(c)},adjacentTilePointCloserToSpawnArea:function(a){var b=this;return _(a.adjacentTilePoints()).sortBy(function(a){return Werld.Utils.Geometry.tileDistance(Werld.Utils.Geometry.pixelPointToTilePoint(b.spawnAreaCircle.center),a)})[0]},randomAdjacentTilePointWithinSpawnArea:function(a){var b=this,c=_(a.adjacentTilePoints()).filter(function(a){return b.tilePointWithinSpawnArea(a)});return _.shuffle(c)[0]},tilePointWithinSpawnArea:function(a){return this.spawnAreaCircle.tilePointWithinArea(a)},randomTilePointWithinSpawnArea:function(){return this.spawnAreaCircle.randomTilePoint()},addCreature:function(){var a=new Werld.Models.Creature(_({coordinates:Werld.Utils.Geometry.tilePointToPixelPoint(this.randomTilePointWithinSpawnArea())}).extend(this.get("creature")));a.on("death",this.scheduleCreatureDestroy),a.on("death",this.scheduleAddCreature),a.on("destroy",this.onCreatureDestroy),this.creatures.add(a)},activate:function(){for(var a=0;a<this.get("numberOfCreatures");a++)this.addCreature()},scheduleCreatureDestroy:function(a){_(a.destroy).delay(this.get("corpseDecayTime"))},scheduleAddCreature:function(a){_(this.addCreature).delay(this.get("respawnTime"))},onCreatureDestroy:function(a){this.creatures.remove(a)}}),Werld.Models.Altar=Backbone.Model.extend({initialize:function(){_.bindAll(this),Werld.Utils.Interval.set(this,"characterResurrectionObserverIntervalId",this.characterResurrectionObserver,Werld.Config.ALTAR_CHARACTER_RESURRECTION_OBSERVER_INTERVAL)},coordinates:function(){return this.get("coordinates")},characterResurrectionObserver:function(){Werld.character.tileDistance(this)<=1&&Werld.character.dead()&&Werld.character.set("hitPoints",1)}}),Werld.Models.Item=Backbone.Model.extend({initialize:function(){this.get("container")&&(this.container=this.get("container"),this.unset("container",{silent:!0}))},stackable:function(){return this.get("stackable")},same:function(a){return this.get("name")===a.get("name")},merge:function(a){this.set("quantity",this.get("quantity")+a.get("quantity"))},transfer:function(a){this.container=a},destroy:function(){this.trigger("destroy",this)},coordinates:function(){return this.container.coordinates()}}),Werld.Models.Game=Backbone.Model.extend({charactersWithinArea:function(a){if(a instanceof Werld.Utils.Circle)return this.charactersWithinCircle(a);throw new Error("Area type unknown")},charactersWithinCircle:function(a){return _(this.get("characters")).filter(function(b){return a.tilePointWithinArea(b.tileCoordinates())})}}),Werld.Models.Base.Container=Backbone.Model.extend({initialize:function(){this.get("owner")?(this.owner=this.get("owner"),this.unset("owner",{silent:!0}),this.owner.items?this.items=this.owner.items:this.owner.get("items")?this.items=this.owner.get("items"):this.items=new Werld.Collections.Items):this.get("items")?(this.items=this.get("items"),this.unset("items",{silent:!0})):this.items=new Werld.Collections.Items},coordinates:function(){if(!this.owner)throw new Error("Item must have an owner to have coordinates");return this.owner.coordinates()}}),Werld.Models.Base.Creature=Backbone.Model.extend({defaults:function(){var a=_(Werld.SKILLS).reduce(function(a,b,c){return a[b.NAME]=0,a},{});return _({lastHitAttemptedAt:Number.NEGATIVE_INFINITY,hitPointRenegerationRate:Werld.Config.REGENERATION_RATE,manaRenegerationRate:Werld.Config.REGENERATION_RATE,staminaRenegerationRate:Werld.Config.REGENERATION_RATE}).extend(a)},initialize:function(a,b){_.bindAll(this),a||(a={}),this.set(a,{silent:!0}),this.options=b||{},this.items=this.get("items")||new Werld.Collections.Items,this.has("threateners")||this.set("threateners",new Werld.Collections.Threateners(null,{sortBy:this.threatenersSortBy})),this.set({hitPoints:this.get("strength"),mana:this.get("intelligence"),stamina:this.get("dexterity"),destination:_.clone(this.get("coordinates")),messages:[]}),this.lootContainer=new Werld.Models.LootContainer(_({owner:this}).extend(Werld.GUMPS.LOOT_CONTAINER)),this.installIntervalFunctions(),this.on("change:hitPoints",this.resurrectIfHitPointsGreaterThanZero),this.on("change:hitPoints",this.dieIfHitPointsLowerThanZero),this.on("resurrection",this.installLifeIntervalFunctions),this.on("death",this.uninstallLifeIntervalFunctions),this.on("destroy",this.uninstallIntervalFunctions),this.on("hitDelivered:critical",this.addCriticalHitMessage),this.on("hitMissed",this.addMissMessage)},maxHitPoints:function(){return this.get("strength")},maxMana:function(){return this.get("intelligence")},maxStamina:function(){return this.get("dexterity")},threatenersSortBy:function(a){return a.tileDistance(this)},addCriticalHitMessage:function(a,b,c){var d=_.clone(this.get("messages"));d.unshift({type:"message",content:"critical!",created_at:Date.now()}),this.set("messages",d)},addMissMessage:function(a,b,c){var d=_.clone(this.get("messages"));d.unshift({type:"message",content:"miss",created_at:Date.now()}),this.set("messages",d)},intervalFunctionNamesWithIntervals:function(){return{messageSweeper:Werld.Config.MESSAGE_SWEEPER_POLLING_INTERVAL,movementHandler:Werld.frameRate()}},lifeIntervalFunctionNamesWithIntervals:function(){return{hitPointRegenerator:this.get("hitPointRenegerationRate"),manaRegenerator:this.get("manaRenegerationRate"),staminaRegenerator:this.get("staminaRenegerationRate"),battleHandler:Werld.frameRate()}},say:function(a){var b=_.clone(this.get("messages"));b.unshift({type:"speech",content:a,created_at:Date.now()}),this.set("messages",b)},tileCoordinates:function(){return Werld.Utils.Geometry.pixelPointToTilePoint(this.get("coordinates"))},move:function(a){this.get("following")&&this.stopFollowing(this.get("following"));var b=this.get("attackee");b&&this.tileDistance(b)>b.get("aggressivenessRadius")&&this.stopAttacking(b),a[0]<0?a[0]=0:a[0]>=Werld.Config.WORLD_MAP_DIMENSIONS[0]&&(a[0]=Werld.Config.WORLD_MAP_DIMENSIONS[1]-1),a[1]<0?a[1]=0:a[1]>=Werld.Config.WORLD_MAP_DIMENSIONS[0]&&(a[1]=Werld.Config.WORLD_MAP_DIMENSIONS[1]-1),this.set({destination:Werld.Utils.Geometry.tilePointToPixelPoint(a)})},states:{attacking:"attacking",beingAttacked:"beingAttacked",following:"following",idle:"idle"},state:function(){return this.has("attackee")?this.states.attacking:this.has("attacker")?this.states.beingAttacked:this.has("following")?this.states.following:this.states.idle},movementHandler:function(){var a=this.get("following");a&&(_(a.get("coordinates")).isEqual(this.get("coordinates"))||this.set("destination",a.get("coordinates")));if(_(this.get("coordinates")).isEqual(this.get("destination"))){this.trigger("idle",this);return}var b=this.get("destination"),c=_.clone(this.get("coordinates")),d=this.get("MOVEMENT_SPEED");c[0]>b[0]?c[0]-=d:c[0]<b[0]&&(c[0]+=d),c[1]>b[1]?c[1]-=d:c[1]<b[1]&&(c[1]+=d),this.set("coordinates",c)},follow:function(a){this.set("following",a)},stopFollowing:function(a){this.follow(null)},attackSpeed:function(){var a=this.has("weapon")?this.get("weapon").get("speed"):this.get("baseAttackSpeed");return _.max([Math.floor(a-this.get("stamina")/30),Werld.Config.MAXIMUM_ATTACK_SPEED])},attacking:function(a){return this.get("attackee")===a},attack:function(a){this.follow(a),this.set("attackee",a),a.acknowledgeAttack(this)},battleHandler:function(){if(!this.has("attackee"))return;this.get("attackee").alive()?this.tileDistance(this.get("attackee"))<1&&Date.now()-this.get("lastHitAttemptedAt")>=this.attackSpeed()*1e3&&this.attemptHit(this.get("attackee")):this.stopAttacking(this.get("attackee"))},acknowledgeAttack:function(a){this.set("attacker",a)},stopMoving:function(){this.set("destination",this.get("coordinates"))},stopAttacking:function(a){this.unset("attackee"),this.stopFollowing(a),a.acknowledgeAttackStop(this)},acknowledgeAttackStop:function(a){this.unset("attacker")},currentCombatSkillName:function(){return this.has("weapon")?this.get("weapon").get("skill"):Werld.SKILLS.WRESTLING.NAME},hitChance:function(a){var b=this.get("dexterity"),c=a.get("dexterity"),d=this.get(this.currentCombatSkillName()),e=a.get(a.currentCombatSkillName());return _.min([100*(d+b/5)/((e+c/5)*2),Werld.Config.MAXIMUM_HIT_CHANCE_PERCENTAGE])},equip:function(a){return a.get("equipable")?this.has(a.get("type"))?!1:(this.set(a.get("type"),a),!0):!1},unequip:function(a){if(!a.get("equipable"))return!1;this.get(a.get("type"))===a&&this.unset(a.get("type"))},damageRange:function(){var a=.35*this.get("strength")+.15*this.get("dexterity")+.6*this.get(this.currentCombatSkillName()),b=_.min([a,Werld.Config.MAXIMUM_DAMAGE_BONUS_PERCENTAGE]),c=this.has("weapon")?this.get("weapon").get("baseDamageRange"):this.get("baseDamageRange");return _(c).map(function(a){return Math.floor(a*(1+b/100))})},blow:function(){var a=this.get("BOUNDARIES"),b=this.get("dexterity")*a.MAX_CRITICAL_HIT_CHANCE/a.MAX_DEXTERITY/100,c=Math.random()<b,d=Werld.Utils.Math.randomIntegerBetween(this.damageRange());return{damage:c?d*2:d,critical:c}},attemptHit:function(a){this.set("lastHitAttemptedAt",Date.now()),this.trigger("hitAttempted",this,a),this.hitChance(a)/100>Math.random()?this.hit(a):this.miss(a)},hit:function(a){var b=this.blow();a.receiveHit(this,b.damage),this.trigger("hitDelivered",this,a,b.damage),b.critical&&this.trigger("hitDelivered:critical",this,a,b.damage)},miss:function(a){this.trigger("hitMissed",this,a)},receiveHit:function(a,b){this.trigger("hitReceived",this,a,b);var c=_.clone(this.get("messages"));c.unshift({type:"hit",content:b,created_at:Date.now()}),this.set("messages",c),this.decrease("hitPoints",b)},alive:function(){return this.get("hitPoints")>0},dead:function(){return!this.alive()},die:function(){this.has("attackee")&&this.stopAttacking(this.get("attackee")),this.set({hitPoints:0,mana:0,stamina:0,messages:[]}),this.trigger("death",this)},resurrect:function(){var a={},b=this;_(["hitPoints","mana","stamina"]).each(function(c){b.get(c)<=0&&(a[c]=1)}),this.set(a),this.trigger("resurrection",this)},installLifeIntervalFunctions:function(a){Werld.Utils.Interval.install(this.lifeIntervalFunctionNamesWithIntervals(),this)},uninstallLifeIntervalFunctions:function(a){Werld.Utils.Interval.uninstall(this.lifeIntervalFunctionNamesWithIntervals(),this)},coordinates:function(){return this.get("coordinates")},tileDistance:function(a){if(!this.coordinates||!a.coordinates)throw new Error('Both objects must implement a "coordinates" function');return Werld.Utils.Geometry.pixelsToTiles(Werld.Utils.Geometry.pixelDistance(this.coordinates(),a.coordinates()))},resurrectIfHitPointsGreaterThanZero:function(a,b,c){this.previous("hitPoints")<=0&&this.get("hitPoints")>0&&this.resurrect()},dieIfHitPointsLowerThanZero:function(a,b,c){this.previous("hitPoints")>0&&this.get("hitPoints")<=0&&this.die()},normalizedSet:function(a,b,c){c||(c={});var d={};_.isNumber(c.min)&&b<c.min?d[a]=c.min:_.isNumber(c.max)&&b>c.max?d[a]=c.max:d[a]=Werld.Utils.Math.toDecimal(b,1),this.set(d)},decrease:function(a,b){this.normalizedSet(a,this.get(a)-b,{min:0})},increase:function(a,b){this.normalizedSet(a,this.get(a)+b,{max:this["max"+_.capitalize(a)]()})},hitPointRegenerator:function(){var a=this.get("strength")/100;this.increase("hitPoints",a)},manaRegenerator:function(){var a=this.get("intelligence")/100;this.increase("mana",a)},staminaRegenerator:function(){var a=this.get("dexterity")/100;this.increase("stamina",a)},messageSweeper:function(){var a=_.clone(this.get("messages")),b=a[a.length-1];b&&Date.now()-b.created_at>Werld.Config.MESSAGE_LIFE_CYCLE&&(a.pop(),this.set("messages",a))},destroy:function(){this.trigger("destroy",this)},getItem:function(a){var b=this.items.find(function(b){return b.stackable()&&b.same(a)});return b?(b.merge(a),a.destroy(),!1):(this.items.add(a),!0)},adjacentTilePoints:function(){var a=this.tileCoordinates();return _([[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]]).reduce(function(b,c){return b.concat([[a[0]+c[0],a[1]+c[1]]])},[])},installIntervalFunctions:function(a){Werld.Utils.Interval.install(_({}).extend(this.intervalFunctionNamesWithIntervals(),this.lifeIntervalFunctionNamesWithIntervals()),this)},uninstallIntervalFunctions:function(a){Werld.Utils.Interval.uninstall(_({}).extend(this.intervalFunctionNamesWithIntervals(),this.lifeIntervalFunctionNamesWithIntervals()),this)}}),Werld.Models.LootContainer=Werld.Models.Base.Container.extend({}),Werld.Models.Tile=Werld.Models.Base.Container.extend({coordinates:function(){return this.get("coordinates")}}),Werld.Models.Character=Werld.Models.Base.Creature.extend({defaults:function(){return _({cumulativeStatCap:200,individualStatCap:100,cumulativeSkillCap:300,individualSkillCap:100}).extend(Werld.Models.Character.__super__.defaults())},initialize:function(){Werld.Models.Character.__super__.initialize.call(this),this.backpack=new Werld.Models.Backpack(_({owner:this}).extend(Werld.GUMPS.BACKPACK)),this.items.each(function(a){a.container=this.backpack},this),this.on("hitAttempted",function(){this.maybeIncreaseCappedAttribute("strength")},this),this.on("hitAttempted",function(){this.maybeIncreaseCappedAttribute("dexterity")},this),this.on("hitAttempted",function(){this.maybeIncreaseCappedAttribute("swordsmanship")},this),this.on("error",function(a,b){console.error({model:a,errors:b})})},statNames:["strength","dexterity","intelligence"],skillNames:["swordsmanship"],cappedAttributeTypes:function(){return["stat","skill"]},cappedAttributeNames:function(a){return a||(a={}),this[a.type+"Names"]},cappedAttributeType:function(a){var b;if(_(this.statNames).include(a))b="stat";else if(_(this.skillNames).include(a))b="skill";else throw new Error("Capped attribute must be a stat or a skill");return b},individualCappedAttributeCap:function(a){return this.get("individual"+_.capitalize(this.cappedAttributeType(a))+"Cap")},cumulativeCappedAttributeCap:function(a){a||(a={});if(!a.type)throw new Error("Must be passed a type");return this.get("cumulative"+_.capitalize(a.type)+"Cap")},statIncreaseChance:function(a){var b=this.get(a);return.03},skillIncreaseChance:function(a){var b=this.get(a);return.05},cappedAttributeIncreaseChance:function(a){var b=this.cappedAttributeType(a)+"IncreaseChance";return this[b](a)},cumulativeCappedAttributePoints:function(a){a||(a={});if(!a.type)throw new Error("Must be passed a type");return _(this[a.type+"Names"]).reduce(_(function(a,b){return a+this.get(b)}).bind(this),0)},statIncrement:function(a){return 1},skillIncrement:function(a){return.1},incrementCappedAttribute:function(a){var b=this.cappedAttributeType(a)+"Increment",c=this[b](a);this.normalizedSet(a,this.get(a)+c)},maybeIncreaseCappedAttribute:function(a){if(this.get(a)>=this.individualCappedAttributeCap(a))return;if(this.cumulativeCappedAttributePoints({type:this.cappedAttributeType(a)})>=this.cumulativeCappedAttributeCap({type:this.cappedAttributeType(a)}))return;this.cappedAttributeIncreaseChance(a)>Math.random()&&this.incrementCappedAttribute(a)},validateCappedAttributes:function(a,b){_(this.cappedAttributeTypes()).each(_(function(c){this.cumulativeCappedAttributePoints({type:c})>this.cumulativeCappedAttributeCap({type:c})&&(b.base="can't exceed cumulative "+c+" cap"),_(this.cappedAttributeNames({type:c})).each(_(function(d){a[d]>this.individualCappedAttributeCap(d)&&(b[d]="can't exceed individual "+c+" cap")}).bind(this))}).bind(this))},validate:function(a){var b={};this.validateCappedAttributes(a,b);if(!_.isEmpty(b))return b}}),Werld.Models.Creature=Werld.Models.Base.Creature.extend({defaults:function(){return _({aggressivenessRadius:Werld.Config.AGGRESSIVENESS_RADIUS,aggressivenessHandlerRate:Werld.Config.AGGRESSIVENESS_HANDLER_RATE,provocability:Werld.Config.PROVOCABILITY,stopAttackingHandlerRate:Werld.Config.STOP_ATTACKING_HANDLER_RATE}).extend(Werld.Models.Creature.__super__.defaults.call(this))},initialize:function(){Werld.Models.Creature.__super__.initialize.call(this);var a=this.get("ITEMS").GOLD,b=Werld.Utils.Math.randomIntegerBetween(a);this.items.add(new Werld.Models.Item(_({container:this.lootContainer,quantity:b}).extend(Werld.ITEMS.GOLD)))},lifeIntervalFunctionNamesWithIntervals:function(){return _({threatenersHandler:this.get("aggressivenessHandlerRate"),threatenersUpdater:this.get("aggressivenessHandlerRate"),stopAttackingHandler:this.get("stopAttackingHandlerRate")}).extend(Werld.Models.Creature.__super__.lifeIntervalFunctionNamesWithIntervals.call(this))},stopAttacking:function(a){Werld.Models.Creature.__super__.stopAttacking.call(this,a),this.stopMoving()},acknowledgeAttack:function(a){Werld.Models.Creature.__super__.acknowledgeAttack.call(this,a),this.attacking(a)||this.attack(a)},threatenersHandler:function(){var a=this.get("threateners").first();if(this.get("threateners").isEmpty())return;if(!this.creatureWithinAggressivenessRadius(a))return;if(Math.random()>this.get("provocability"))return;this.has("attackee")?this.get("attackee").tileDistance(this)>a.tileDistance(this)&&this.attack(a):this.attack(a)},threatenersUpdater:function(){var a=Werld.game.charactersWithinArea(this.aggressivenessAreaCircle()),b=_(a).filter(function(a){return a.alive()});a.length>0&&this.get("threateners").update(b)},aggressivenessAreaCircle:function(){return new Werld.Utils.Circle({center:this.tileCoordinates(),radius:this.get("aggressivenessRadius"),measurement:"tiles"})},tilePointWithinAggressivenessRadius:function(a){return this.aggressivenessAreaCircle().tilePointWithinArea(a)},creatureWithinAggressivenessRadius:function(a){return this.tilePointWithinAggressivenessRadius(a.tileCoordinates())},stopAttackingHandler:function(){if(!this.has("attackee"))return;this.get("attackee").attacking(this)||this.creatureWithinAggressivenessRadius(this.get("attackee"))||this.stopAttacking(this.get("attackee"))}}),Werld.Models.Screen=Backbone.Model.extend({initialize:function(){this.get("character").bind("change:coordinates",this.updateCoordinates,this)},updateCoordinates:function(){var a=this.get("character").get("coordinates"),b=this.get("dimensions");this.set({coordinates:[a[0]-Werld.Utils.Geometry.tilesToPixels(Math.floor(b[0]/2)),a[1]-Werld.Utils.Geometry.tilesToPixels(Math.floor(b[1]/2))]})},objectCoordinates:function(a){return[a.get("coordinates")[0]-this.get("coordinates")[0],a.get("coordinates")[1]-this.get("coordinates")[1]]}}),Werld.Models.Backpack=Werld.Models.Base.Container.extend({}),Werld.Views.StatusBar=Backbone.View.extend({initialize:function(){_.bindAll(this),this.container=new Container,this.container.view=this,this.container.x=0,this.container.y=405,this.container.onPress=this.onContainerPress,this.container.onMouseOver=this.onContainerMouseOver,this.container.onMouseOut=this.onContainerMouseOut,this.statusBarRectangle=new Rectangle(0,0,250,75);var a=new Graphics;a.beginFill("#ccc").drawRoundRect(this.statusBarRectangle.x,this.statusBarRectangle.y,this.statusBarRectangle.width,this.statusBarRectangle.height,5).endFill(),this.statusBarRectangleShape=new Shape(a),this.statusBarRectangleShape.alpha=.5,this.statsRectangle=new Rectangle(0,0,100,75),this.hitPointsStaminaManaRectangle=new Rectangle(100,0,150,75),this.strengthTextKey=new Text("STR",'16px "PowellAntique" serif',"white"),this.strengthTextKey.x=this.statsRectangle.x+25;var b=this.strengthTextKey.x+this.strengthTextKey.getMeasuredWidth(),c=b;this.strengthTextKey.y=5,this.strengthTextKey.textBaseline="top",this.strengthTextKey.textAlign="center",this.strengthTextValue=new Text(this.model.get("strength"),'16px "PowellAntique" serif',"white"),this.strengthTextValue.textBaseline="top",this.strengthTextValue.textAlign="center",this.strengthTextValue.y=this.strengthTextKey.y,this.strengthTextValue.x=c,this.container.addChild(this.strengthTextKey),this.container.addChild(this.strengthTextValue),this.dexterityTextKey=new Text("DEX",'16px "PowellAntique" serif',"white"),this.dexterityTextKey.x=this.statsRectangle.x+25,b=this.dexterityTextKey.x+this.dexterityTextKey.getMeasuredWidth(),c=b,this.dexterityTextKey.y=this.strengthTextKey.y+this.strengthTextKey.getMeasuredLineHeight(),this.dexterityTextKey.textBaseline="top",this.dexterityTextKey.textAlign="center",this.dexterityTextValue=new Text(this.model.get("dexterity"),'16px "PowellAntique" serif',"white"),this.dexterityTextValue.textBaseline="top",this.dexterityTextValue.textAlign="center",this.dexterityTextValue.y=this.dexterityTextKey.y,this.dexterityTextValue.x=c,this.container.addChild(this.dexterityTextKey),this.container.addChild(this.dexterityTextValue),this.intelligenceTextKey=new Text("INT",'16px "PowellAntique" serif',"white"),this.intelligenceTextKey.x=this.statsRectangle.x+25,b=this.intelligenceTextKey.x+this.intelligenceTextKey.getMeasuredWidth(),c=b,this.intelligenceTextKey.y=this.dexterityTextKey.y+this.dexterityTextKey.getMeasuredLineHeight(),this.intelligenceTextKey.textBaseline="top",this.intelligenceTextKey.textAlign="center",this.intelligenceTextValue=new Text(this.model.get("intelligence"),'16px "PowellAntique" serif',"white"),this.intelligenceTextValue.textBaseline="top",this.intelligenceTextValue.textAlign="center",this.intelligenceTextValue.y=this.intelligenceTextKey.y,this.intelligenceTextValue.x=c,this.container.addChild(this.intelligenceTextKey),this.container.addChild(this.intelligenceTextValue),this.hitPointsTextKey=new Text("H",'16px "PowellAntique" serif',"white"),this.hitPointsTextKey.x=this.hitPointsStaminaManaRectangle.x+15,b=this.hitPointsTextKey.x+this.hitPointsTextKey.getMeasuredWidth(),c=b+(this.statusBarRectangle.width-b)/2,this.hitPointsTextKey.y=5,this.hitPointsTextKey.textBaseline="top",this.hitPointsTextKey.textAlign="center",this.hitPointsTextValue=new Text(this.model.get("hitPoints")+"/"+this.model.maxHitPoints(),'16px "PowellAntique" serif',"white"),this.hitPointsTextValue.textBaseline="top",this.hitPointsTextValue.textAlign="center",this.hitPointsTextValue.y=this.hitPointsTextKey.y,this.hitPointsTextValue.x=c;var d=this.model.maxHitPoints()/this.model.get("hitPoints"),e=5;this.hitPointsBarRectangle=new Rectangle(b+e,this.hitPointsTextKey.y,d*(this.statusBarRectangle.width-b-2*e),this.hitPointsTextKey.getMeasuredLineHeight()),this.hitPointsBarGraphics=new Graphics,this.hitPointsBarGraphics.beginFill("red").drawRoundRect(this.hitPointsBarRectangle.x,this.hitPointsBarRectangle.y,this.hitPointsBarRectangle.width,this.hitPointsBarRectangle.height,2).endStroke().endFill(),this.hitPointsBar=new Shape(this.hitPointsBarGraphics),this.hitPointsBar.alpha=.5,this.staminaTextKey=new Text("S",'16px "PowellAntique" serif',"white"),this.staminaTextKey.x=this.hitPointsTextKey.x,this.staminaTextKey.y=this.hitPointsTextKey.y+this.staminaTextKey.getMeasuredLineHeight(),this.staminaTextKey.textBaseline="top",this.staminaTextKey.textAlign="center",this.staminaTextValue=new Text(this.model.get("stamina")+"/"+this.model.maxStamina(),'16px "PowellAntique" serif',"white"),this.staminaTextValue.textBaseline="top",this.staminaTextValue.textAlign="center",this.staminaTextValue.y=this.staminaTextKey.y,this.staminaTextValue.x=c,this.staminaBarRectangle=new Rectangle(b+e,this.staminaTextKey.y,this.statusBarRectangle.width-b-2*e,this.staminaTextKey.getMeasuredLineHeight()),this.staminaBarGraphics=new Graphics,this.staminaBarGraphics.beginFill("yellow").drawRoundRect(this.staminaBarRectangle.x,this.staminaBarRectangle.y,this.staminaBarRectangle.width,this.staminaBarRectangle.height,2).endStroke().endFill(),this.staminaBar=new Shape(this.staminaBarGraphics),this.staminaBar.alpha=.5,this.manaTextKey=new Text("M",'16px "PowellAntique" serif',"white"),this.manaTextKey.x=this.staminaTextKey.x,this.manaTextKey.y=this.staminaTextKey.y+this.manaTextKey.getMeasuredLineHeight(),this.manaTextKey.textBaseline="top",this.manaTextKey.textAlign="center",this.manaTextValue=new Text(this.model.get("mana")+"/"+this.model.maxMana(),'16px "PowellAntique" serif',"white"),this.manaTextValue.textBaseline="top",this.manaTextValue.textAlign="center",this.manaTextValue.y=this.manaTextKey.y,this.manaTextValue.x=c,this.manaBarRectangle=new Rectangle(b+e,this.manaTextKey.y,this.statusBarRectangle.width-b-2*e,this.manaTextKey.getMeasuredLineHeight()),this.manaBarGraphics=new Graphics,this.manaBarGraphics.beginFill("blue").drawRoundRect(this.manaBarRectangle.x,this.manaBarRectangle.y,this.manaBarRectangle.width,this.manaBarRectangle.height,2).endStroke().endFill(),this.manaBar=new Shape(this.manaBarGraphics),this.manaBar.alpha=.5,this.container.addChild(this.statusBarRectangleShape),this.container.addChild(this.hitPointsBar),this.container.addChild(this.hitPointsTextKey),this.container.addChild(this.hitPointsTextValue),this.container.addChild(this.staminaBar),this.container.addChild(this.staminaTextKey),this.container.addChild(this.staminaTextValue),this.container.addChild(this.manaBar),this.container.addChild(this.manaTextKey),this.container.addChild(this.manaTextValue),this.model.on("change:strength change:dexterity change:intelligence",this.updateStats),this.model.on("change:hitPoints change:stamina change:mana",this.update)},onContainerPress:function(a){a.nativeEvent.which===1&&(this.pressEventOffset=[this.container.x-a.stageX,this.container.y-a.stageY],a.onMouseMove=this.onContainerMouseMove)},onContainerMouseMove:function(a){this.container.x=a.stageX+this.pressEventOffset[0],this.container.y=a.stageY+this.pressEventOffset[1]},onContainerMouseOver:function(){Werld.canvas.el.style.cursor="pointer",this.container.scaleX=this.container.scaleY=1.05},onContainerMouseOut:function(a){Werld.canvas.el.style.cursor="",this.container.scaleX=this.container.scaleY=1},updateStats:function(){this.strengthTextValue.text=this.model.get("strength"),this.dexterityTextValue.text=this.model.get("dexterity"),this.intelligenceTextValue.text=this.model.get("intelligence")},update:function(){var a=5,b=this.hitPointsTextKey.x+this.hitPointsTextKey.getMeasuredWidth(),c=this.model.get("hitPoints")/this.model.maxHitPoints();this.hitPointsBarRectangle.width=c*(this.statusBarRectangle.width-b-2*a),this.hitPointsBarGraphics.clear().beginFill("red").drawRoundRect(this.hitPointsBarRectangle.x,this.hitPointsBarRectangle.y,this.hitPointsBarRectangle.width,this.hitPointsBarRectangle.height,2).endStroke().endFill(),this.hitPointsTextValue.text=Math.floor(this.model.get("hitPoints"))+"/"+this.model.maxHitPoints();var d=this.model.get("mana")/this.model.maxMana();this.manaBarRectangle.width=d*(this.statusBarRectangle.width-b-2*a),this.manaBarGraphics.clear().beginFill("blue").drawRoundRect(this.manaBarRectangle.x,this.manaBarRectangle.y,this.manaBarRectangle.width,this.manaBarRectangle.height,2).endStroke().endFill(),this.manaTextValue.text=Math.floor(this.model.get("mana"))+"/"+this.model.maxMana();var e=this.model.get("stamina")/this.model.maxStamina();this.staminaBarRectangle.width=e*(this.statusBarRectangle.width-b-2*a),this.staminaBarGraphics.clear().beginFill("yellow").drawRoundRect(this.staminaBarRectangle.x,this.staminaBarRectangle.y,this.staminaBarRectangle.width,this.staminaBarRectangle.height,2).endStroke().endFill(),this.staminaTextValue.text=Math.floor(this.model.get("stamina"))+"/"+this.model.maxStamina()}}),Werld.Views.SplashScreen=Backbone.View.extend({initialize:function(){var a=new Bitmap("images/splash.jpg");a.x=0,a.y=0;var b=new Text("Werld Online",'90px "PowellAntique" serif',"#dc9a44");b.shadow=new Shadow("#000000",4,4,0),b.textAlign="center",b.x=320,b.y=120;var c=new Text("Sign In",'40px "PowellAntique" serif',"#dc9a44");c.textBaseline="bottom",c.x=400,c.y=320,c.shadow=new Shadow("#000000",2,2,0);var d=new Graphics,e=c.x+c.getMeasuredWidth()/2,f=c.y-c.getMeasuredLineHeight()/2,g=10,h=110;d.beginRadialGradientFill(["#dc9a44","#000000"],[0,.9],e,f,g,e,f,h),d.drawCircle(e,f,h);var i=new Shape(d);i.alpha=.3,i.compositeOperation="lighter",i.visible=!1;var j=new Graphics,k=c.getMeasuredWidth()+50,l=c.getMeasuredLineHeight()+50;j.beginFill("rgba(0,0,0,0.01)"),j.drawEllipse(c.x-(k-c.getMeasuredWidth())/2,(2*c.y-c.getMeasuredLineHeight()-l)/2,k,l);var m=new Shape(j);m.onMouseOver=function(){m.getStage().canvas.style.cursor="pointer",i.visible=!0},m.onMouseOut=function(){m.getStage().canvas.style.cursor="",i.visible=!1},m.onClick=function(){m.getStage().canvas.style.cursor="",Werld.switchState(Werld.STATES.CHOOSING_NAME,{callback:function(){m.onMouseOver=null,m.onMouseOut=null,m.onClick=null,m.visible=!1}})},this.container=new Container,this.container.addChild(a),this.container.addChild(b),this.container.addChild(m),this.container.addChild(i),this.container.addChild(c)}}),Werld.Views.CharacterNameInputForm=Backbone.View.extend({el:"#character-name-input-form",initialize:function(){$(this.el).bind("submit",_.bind(this.submit,this))},render:function(){$(this.el).show(),$("input",this.el).focus()},submit:function(){return Werld.switchState(Werld.STATES.GAME_STARTED,{data:{character:{name:$("#character-name-input",this.el).val()}}}),$("input",this.el).val("").blur(),$(this.el).hide(),!1}}),Werld.Views.Altar=Backbone.View.extend({initialize:function(){_.bindAll(this),this.container=new Container,this.container.view=this;var a=new Bitmap(this.model.get("IMAGE").SRC);this.container.addChild(a),this.updateContainerOnScreenCoordinates(),Werld.character.on("change:coordinates",this.updateContainerOnScreenCoordinates)},updateContainerOnScreenCoordinates:function(){var a=Werld.screen.objectCoordinates(this.model);this.container.x=a[0],this.container.y=a[1]}}),Werld.Views.Item=Backbone.View.extend({initialize:function(){_.bindAll(this),this.container=new Container,this.container.view=this,this.bitmap=new Bitmap(Werld.IMAGES[this.model.get("name")].SRC),this.container.addChild(this.bitmap),this.model.get("stackable")&&(this.tooltipView=new Werld.Views.Tooltip({model:this.model,observedProperties:["quantity"],output:function(){return this.model.get("quantity")}}),this.container.addChild(this.tooltipView.container)),this.model.bind("destroy",this.onModelDestroy),this.bitmap.onDoubleClick=this.onBitmapDoubleClick,this.bitmap.onPress=this.onBitmapPress,this.bitmap.onMouseOut=this.onBitmapMouseOut,this.bitmap.onMouseOver=this.onBitmapMouseOver},onModelDestroy:function(a){this.container.parent.removeChild(this.container),delete this.bitmap.onDoubleClick,delete this.bitmap.onPress,delete this.bitmap.onMouseOut,delete this.bitmap.onMouseOver},onBitmapPress:function(a){a.nativeEvent.which===1&&(Werld.Utils.Easel.bringDisplayObjectToFront(this.container),this.coordinatesOnPress=[this.container.x,this.container.y],this.pressEventOffset=[this.container.x-a.stageX,this.container.y-a.stageY],Werld.character.tileDistance(this.model)<=1&&(Werld.containers.itemTransfer.x=this.container.parent.x,Werld.containers.itemTransfer.y=this.container.parent.y,this.container.parentBeforePress=this.container.parent,this.container.parent.removeChild(this.container),Werld.containers.itemTransfer.addChild(this.container),a.onMouseMove=this.onBitmapMouseMove,a.onMouseUp=this.onBitmapMouseUp))},onBitmapMouseMove:function(a){this.container.x=a.stageX+this.pressEventOffset[0],this.container.y=a.stageY+this.pressEventOffset[1]},handleItemDrop:function(a){return this.model.same(a)&&this.model.stackable()?(a.collection.remove(a),this.model.merge(a),!0):!1},onBitmapMouseUp:function(a){var b=Werld.stage.getObjectsUnderPoint(a.stageX,a.stageY)[1],c=b.parent.view;Werld.containers.itemTransfer.removeChild(this.container),this.container.parent=this.container.parentBeforePress,this.container.parent.addChild(this.container),delete this.container.parentBeforePress,Werld.Utils.Callback.run(c.handleItemDrop,this.model)?this.model.transfer(c.model):this.cancelMovement()},cancelMovement:function(){this.container.x=this.coordinatesOnPress[0],this.container.y=this.coordinatesOnPress[1]},onBitmapMouseOver:function(){Werld.canvas.el.style.cursor="pointer",this.showToolTip()},onBitmapMouseOut:function(){Werld.canvas.el.style.cursor="",this.hideToolTip()},showToolTip:function(){},hideToolTip:function(){}}),Werld.Views.GameMessages=Backbone.View.extend({initialize:function(){_.bindAll(this),this.container=this.options.container,this.model.on("change:strength change:dexterity change:intelligence",this.addCharacterStatChangeMessage),this.model.on("change:swordsmanship",this.addCharacterSkillChangeMessage),this.collection.on("add remove reset",this.render)},addCharacterStatChangeMessage:function(a,b,c){var d=_.keys(c.changes)[0],e=a.get(d)-a.previous(d),f;e>0?f="increased":e<0&&(f="decreased");var g="Your "+d+" has "+f+" by "+e+". It is now "+a.get(d)+".";this.addCharacterAttributeChangeMessage(d,e,{message:g,type:"stat"})},addCharacterSkillChangeMessage:function(a,b,c){var d=_.keys(c.changes)[0],e=a.get(d)-a.previous(d),f;e>0?f="increased":e<0&&(f="decreased");var g="Your skill in "+d+" has "+f+" by "+e.toFixed(1)+". It is now "+a.get(d).toFixed(1)+".";this.addCharacterAttributeChangeMessage(d,e,{message:g,type:"skill"})},addCharacterAttributeChangeMessage:function(a,b,c){var d;b>0?d="_INCREASE":b<0&&(d="_DECREASE");var e=new Backbone.Model({type:Werld.MESSAGES[(c.type||a).toUpperCase()+d].NAME,body:c.message,created_at:Date.now()});this.collection.add(e)},render:function(){this.container.removeAllChildren();var a={bottom:10,left:10},b=480;this.collection.each(function(c,d,e){var f=new Text(c.get("body"),Werld.MESSAGES[c.get("type")].FONT,Werld.MESSAGES[c.get("type")].COLOR);f.textAlign="left",f.x=a.left,f.y=b-(d*f.getMeasuredLineHeight()+a.bottom),f.shadow=new Shadow("#000000",1,1,0),this.container.addChild(f)},this)}}),Werld.Views.Base.Container=Backbone.View.extend({initialize:function(){_.bindAll(this),this.itemViews=[],this.container=new Container,this.container.view=this,this.model.items.on("add",this.addItemView),this.model.items.on("remove",this.removeItemView),this.model.items.each(this.addItemView)},addItemView:function(a){var b=new Werld.Views.Item({model:a});this.itemViews.push(b),this.container.addChild(b.container)},removeItemView:function(a){var b=_(this.itemViews).find(function(b){return b.model===a});this.itemViews=_(this.itemViews).without(b),this.container.removeChild(b.container)},handleItemDrop:function(a){return a.collection!==this.model.items&&(a.collection.remove(a),this.model.items.add(a)),!0}}),Werld.Views.Base.Creature=Backbone.View.extend({initialize:function(){_.bindAll(this),this.container=new Container,this.container.view=this,this.lootContainerView=new Werld.Views.LootContainer({model:this.model.lootContainer,character:Werld.character});var a=this.model.get("SPRITE"),b=new Image;b.src=a.SRC,b.onload=_.bind(function(){this.spriteSheet=new SpriteSheet({images:[b],frames:{width:a.DIMENSIONS[0],height:a.DIMENSIONS[1],regX:(a.DIMENSIONS[0]-Werld.Config.PIXELS_PER_TILE)/2,regY:(1.7*a.DIMENSIONS[1]-Werld.Config.PIXELS_PER_TILE)/2},animations:{walkDown:[0,3,!0,1/a.FREQUENCY],walkLeft:[4,7,!0,1/a.FREQUENCY],walkRight:[8,11,!0,1/a.FREQUENCY],walkUp:[12,15,!0,1/a.FREQUENCY]}}),this.bitmapAnimation=new BitmapAnimation(this.spriteSheet),this.bitmapAnimation.currentFrame=0,this.bitmapAnimation.onMouseOver=this.onBitmapAnimationMouseOver,this.bitmapAnimation.onMouseOut=this.onBitmapAnimationMouseOut,this.bitmapAnimation.onDoubleClick=this.onBitmapAnimationDoubleClick,this.nameText=new Text,this.updateCreatureName(),this.messagesContainer=new Container,this.messagesContainer.y=this.container.y-20,this.container.addChild(this.bitmapAnimation),this.container.addChild(this.nameText),this.container.addChild(this.messagesContainer),this.updateContainerOnScreenCoordinates(),this.model.on("destroy",this.onModelDestroy),this.model.on("death resurrection",this.updateCreatureName),this.model.on("death",this.pauseBitmapAnimation),this.model.on("idle",this.pauseBitmapAnimation),this.model.on("change:coordinates",this.updateBitmapAnimation),this.model.on("change:coordinates",this.updateContainerOnScreenCoordinates),this.model.on("change:messages",this.messagesContainerTick)},this)},updateContainerOnScreenCoordinates:function(){var a=Werld.screen.objectCoordinates(this.model);this.container.x=a[0],this.container.y=a[1]},onBitmapAnimationMouseOver:function(a){Werld.canvas.el.style.cursor="pointer"},onBitmapAnimationMouseOut:function(a){Werld.canvas.el.style.cursor=""},onBitmapAnimationDoubleClick:function(a){if(Werld.character.dead())return;this.model!==Werld.character&&(this.model.alive()?Werld.character.attack(this.model):Werld.character.tileDistance(this.model)<=1&&this.showLoot())},showLoot:function(){this.lootContainerView.show()},pauseBitmapAnimation:function(a){this.bitmapAnimation.currentAnimationFrame=0,this.bitmapAnimation.paused=!0},updateBitmapAnimation:function(a){this.bitmapAnimation.paused=!1,this.model.get("coordinates")[1]>this.model.previous("coordinates")[1]?this.bitmapAnimation.currentAnimation!=="walkDown"&&this.bitmapAnimation.gotoAndPlay("walkDown"):this.model.get("coordinates")[1]<this.model.previous("coordinates")[1]?this.bitmapAnimation.currentAnimation!=="walkUp"&&this.bitmapAnimation.gotoAndPlay("walkUp"):this.model.get("coordinates")[0]>this.model.previous("coordinates")[0]?this.bitmapAnimation.currentAnimation!=="walkRight"&&this.bitmapAnimation.gotoAndPlay("walkRight"):this.model.get("coordinates")[0]<this.model.previous("coordinates")[0]&&this.bitmapAnimation.currentAnimation!=="walkLeft"&&this.bitmapAnimation.gotoAndPlay("walkLeft")},updateCreatureName:function(){this.nameText.text=this.nameTextText(),this.nameText.font=this.nameTextFont,this.nameText.color=this.nameTextColor,this.nameTextShadow&&(this.nameText.shadow=this.nameTextShadow),this.nameText.textBaseline="top",this.nameText.textAlign="center",this.nameText.x=20,this.nameText.y=-(this.spriteSheet._regY+28)},messagesContainerTick:function(){var a=[0,0],b=this;this.messagesContainer.removeAllChildren(),_(this.model.get("messages")).each(function(c){c.content!==""&&(b.messageText=new Text,b.messagesContainer.addChild(b.messageText),b.messageText.text=c.content,b.messageText.textAlign="center",c.type==="speech"?(b.messageText.color="#cccccc",b.messageText.font='16px "PowellAntique" serif'):c.type==="critical"?(b.messageText.shadow=new Shadow("black",1,1,1),b.messageText.color="#ff3300",b.messageText.font='14px "PowellAntique" serif'):c.type==="hit"?(b.messageText.text=Math.ceil(b.messageText.text),b.messageText.shadow=new Shadow("black",1,1,1),b.messageText.color="#ff3300",b.messageText.font='14px "PowellAntique" serif'):(b.messageText.color="#cccccc",b.messageText.font='16px "PowellAntique" serif'),a[1]-=b.messageText.getMeasuredLineHeight(),b.messageText.x=20,b.messageText.y=a[1])})},onModelDestroy:function(){this.container.parent.removeChild(this.container),delete this.bitmapAnimation.onMouseOver,delete this.bitmapAnimation.onMouseOut}}),Werld.Views.MessageInputForm=Backbone.View.extend({el:"#message-input-form",initialize:function(){var a=this;return $(this.el).submit(function(b){return Werld.character.say($("input",a.el).val()),$("input",a.el).val("").blur(),$(a.el).hide(),!1}),this},showOrSubmit:function(a){$(this.el).css("display")==="none"?(a.preventDefault(),$(this.el).show(),$("input",this.el).focus()):$(this.el).submit()}}),Werld.Views.LootContainer=Werld.Views.Base.Container.extend({initialize:function(){Werld.Views.LootContainer.__super__.initialize.call(this),_.bindAll(this),this.character=this.options.character,this.model.owner.on("destroy",this.removeContainerFromGumpsContainer),this.bitmap=new Bitmap(Werld.IMAGES[this.model.get("name")].SRC),this.bitmap.onPress=this.onBitmapPress,this.container.addChildAt(this.bitmap,0),Werld.containers.gumps.addChild(this.container),this.hide()},removeContainerFromGumpsContainer:function(a){Werld.containers.gumps.removeChild(this.container)},onBitmapPress:function(a){a.nativeEvent.which===1?(Werld.Utils.Easel.bringDisplayObjectToFront(this.container),this.pressEventOffset=[this.container.x-a.stageX,this.container.y-a.stageY],a.onMouseMove=this.onBitmapMouseMove):a.nativeEvent.which===3&&this.hide()},onBitmapMouseMove:function(a){this.container.x=a.stageX+this.pressEventOffset[0],this.container.y=a.stageY+this.pressEventOffset[1]},onCharacterCoordinatesChange:function(){this.character.tileDistance(this.model.owner)>=2&&(this.character.off("change:coordinates",this.onCharacterCoordinatesChange),this.hide())},hide:function(){this.container.visible=!1},hidden:function(){return!this.container.visible},show:function(){if(!this.hidden())return;var a=this.model.owner.get("coordinates"),b=this.container.parent.screen.get("coordinates");this.container.x=a[0]-b[0],this.container.y=a[1]-b[1],this.container.visible=!0,Werld.Utils.Easel.bringDisplayObjectToFront(this.container),this.character.on("change:coordinates",this.onCharacterCoordinatesChange)}}),Werld.Views.MessageInputFormHandler=Backbone.View.extend({el:window,events:{keypress:"onWindowKeyPress"},initialize:function(){this.messageInputView=new Werld.Views.MessageInputForm},onWindowKeyPress:function(a){Werld.state===Werld.STATES.GAME_STARTED&&a.which===13&&this.messageInputView.showOrSubmit(a)}}),Werld.Views.Tile=Werld.Views.Base.Container.extend({initialize:function(){Werld.Views.Tile.__super__.initialize.call(this),_.bindAll(this),this.model.bind("change",this.onModelChange),this.bitmap=new Bitmap(Werld.canvas.textures.tiles[this.model.get("type")]),this.bitmap.onPress=this.onBitmapPress,this.container.addChild(this.bitmap)},onBitmapPress:function(a){Werld.character.move(_(this.model.get("coordinates")).map(Werld.Utils.Geometry.pixelsToTiles))},onModelChange:function(a){this.container.x=this.model.get("onScreenCoordinates")[0],this.container.y=this.model.get("onScreenCoordinates")[1]},hide:function(){this.container.visible=!1},unhide:function(){this.container.visible=!0},handleItemDrop:function(a){return Werld.character.tileDistance(this.model)<=1?(a.collection.remove(a),this.model.items.add(a),!0):!1}}),Werld.Views.Tooltip=Backbone.View.extend({initialize:function(){this.output=this.options.output,_.bindAll(this),this.container=new Container,this.container.view=this,this.container.x=Werld.Config.PIXELS_PER_TILE*.7,this.container.y=Werld.Config.PIXELS_PER_TILE*.6,_(this.options.observedProperties).each(this.bindObservedPropertyToUpdate),this.createDisplayObjects()},bindObservedPropertyToUpdate:function(a){this.model.bind("change:"+a,this.update)},update:function(){this.text.text=this.output(),this.rectangle.width=this.text.getMeasuredWidth()+this.padding.right+this.padding.left,this.rectangle.height=this.text.getMeasuredLineHeight()+this.padding.top+this.padding.bottom,this.drawRectangle()},drawRectangle:function(){this.rectangleGraphics.clear().beginFill("#000").drawRoundRect(this.rectangle.x,this.rectangle.y,this.rectangle.width,this.rectangle.height,2).endFill()},createDisplayObjects:function(){this.text=new Text(this.output(),"bold 8px sans serif","white"),this.text.textBaseline="top",this.padding={top:2,right:4,bottom:2,left:4},this.rectangle=new Rectangle(-(this.padding.right+this.padding.left)/2,-(this.padding.top+this.padding.bottom)/2,this.text.getMeasuredWidth()+this.padding.right+this.padding.left,this.text.getMeasuredLineHeight()+this.padding.top+this.padding.bottom),this.rectangleGraphics=new Graphics,this.drawRectangle(),this.rectangleGraphicsShape=new Shape(this.rectangleGraphics),this.container.addChild(this.rectangleGraphicsShape),this.container.addChild(this.text)}}),Werld.Views.Character=Werld.Views.Base.Creature.extend({nameTextFont:'18px "PowellAntique" serif',nameTextColor:"#6495ed",nameTextShadow:new Shadow("black",1,1,1),nameTextText:function(){return this.model.get("name")}}),Werld.Views.Creature=Werld.Views.Base.Creature.extend({nameTextFont:'16px "PowellAntique" serif',nameTextColor:"#cccccc",nameTextShadow:new Shadow("black",1,1,1),initialize:function(){Werld.Views.Creature.__super__.initialize.call(this),this.hitPointsBarRectangleWidth=50,this.hitPointsBarRectangle=new Rectangle(this.container.x-(this.hitPointsBarRectangleWidth-Werld.Config.PIXELS_PER_TILE)/2,-0.21*Math.pow(this.model.get("SPRITE").DIMENSIONS[1],5/4),this.hitPointsBarRectangleWidth,6),this.hitPointsBarGraphics=new Graphics,this.hitPointsBar=new Shape(this.hitPointsBarGraphics),this.hitPointsBar.alpha=.7,this.container.addChild(this.hitPointsBar),this.updateHitPointsBar(this.model),this.model.on("death",this.showLootIfCharacterIsClose),this.model.on("change:hitPoints",this.updateHitPointsBar),Werld.character.on("change:coordinates",this.updateContainerOnScreenCoordinates)},nameTextText:function(){return this.model.alive()?this.model.get("name"):this.model.get("name")+" corpse"},updateHitPointsBar:function(a){var b=this.model.get("hitPoints")/this.model.maxHitPoints();this.hitPointsBarRectangle.width=b*this.hitPointsBarRectangleWidth,this.hitPointsBarGraphics.clear(),this.hitPointsBarRectangle.width>0&&this.hitPointsBarGraphics.beginFill("red").beginStroke("black").drawRoundRect(this.hitPointsBarRectangle.x,this.hitPointsBarRectangle.y,this.hitPointsBarRectangle.width,this.hitPointsBarRectangle.height,1).endStroke().endFill()},showLootIfCharacterIsClose:function(){this.model.tileDistance(Werld.character)<=1&&this.showLoot()}}),Werld.Views.Screen=Backbone.View.extend({initialize:function(){_.bindAll(this),this.mapTileViews=[],this.container=new Container,this.model.get("character").on("death resurrection",this.onCharacterChangeStatus),this.model.get("character").on("change:coordinates",this.onCharacterChangeCoordinates),this.createMapTileViews()},createMapTileViews:function(){var a=this.model.get("map").get("tiles");for(var b=0;b<a.length;b++){this.mapTileViews[b]=[];for(var c=0;c<a[b].length;c++)this.mapTileViews[b][c]=new Werld.Views.Tile({model:a[b][c]}),this.container.addChild(this.mapTileViews[b][c].container)}this.update()},update:function(){var a=this.model.get("coordinates"),b=this.model.get("dimensions"),c=_(a).map(function(a){return Werld.Utils.Geometry.pixelsToTiles(a)}),d=_(a).map(function(a){return a-Math.floor(a/Werld.Config.PIXELS_PER_TILE)*Werld.Config.PIXELS_PER_TILE}),e,f;for(e=0;e<this.mapTileViews.length;e++)for(f=0;f<this.mapTileViews[e].length;f++)this.mapTileViews[e][f].hide();for(e=0;e<=b[0];e++)for(f=0;f<=b[1];f++){var g=[e+c[0],f+c[1]];g[0]>0&&g[0]<Werld.Config.WORLD_MAP_DIMENSIONS[0]&&g[1]>0&&g[1]<Werld.Config.WORLD_MAP_DIMENSIONS[1]&&(this.mapTileViews[g[0]][g[1]].model.set({onScreenCoordinates:[Werld.Utils.Geometry.tilesToPixels(e)-d[0],Werld.Utils.Geometry.tilesToPixels(f)-d[1]]}),this.mapTileViews[g[0]][g[1]].unhide())}},onCharacterChangeCoordinates:function(){this.update()},onCharacterChangeStatus:function(){var a=this,b=function(a){var b=new Text(a,'40px "PowellAntique" serif',"#dc9a44");b.textAlign="center",b.x=320,b.y=200,b.shadow=new Shadow("#000000",2,2,0),Werld.containers.gameMessages.addChild(b),_(function(){Werld.containers.gameMessages.removeChild(b)}).delay(3e3)};this.model.get("character").alive()?b("You are alive"):this.model.get("character").dead()&&b("You are dead")}}),Werld.Views.Backpack=Werld.Views.Base.Container.extend({initialize:function(){Werld.Views.Backpack.__super__.initialize.call(this),_.bindAll(this),this.bitmap=new Bitmap(Werld.IMAGES[this.model.get("name")].SRC),this.bitmap.onPress=this.onBitmapPress,this.container.x=470,this.container.y=270,this.container.addChildAt(this.bitmap,0)},onBitmapPress:function(a){a.nativeEvent.which===1&&(Werld.Utils.Easel.bringDisplayObjectToFront(this.container),this.pressEventOffset=[this.container.x-a.stageX,this.container.y-a.stageY],a.onMouseMove=this.onBitmapMouseMove)},onBitmapMouseMove:function(a){this.container.x=a.stageX+this.pressEventOffset[0],this.container.y=a.stageY+this.pressEventOffset[1]},onBitmapMouseOver:function(){Werld.canvas.el.style.cursor="pointer"},onBitmapMouseOut:function(){Werld.canvas.el.style.cursor=""}}),Werld.Collections.Items=Backbone.Collection.extend({model:Werld.Models.Item}),Werld.Collections.CreatureSpawners=Backbone.Collection.extend({activateAll:function(){this.each(function(a){a.activate()})}}),Werld.Canvas=Backbone.View.extend({el:"canvas",initialize:function(){this.context=this.el.getContext("2d"),this.loadTextures()},loadTextures:function(a){this.textures={},this.textures.tiles={},this.textures.tiles.grass="images/textures/tiles/grass.jpg",this.textures.tiles.dirt="images/textures/tiles/dirt.jpg"}}),_.mixin(_.string.exports()),_.string.include("Underscore.string","string"),Werld.Utils={},Werld.Utils.Geometry={tilesToPixels:function(a){return a*Werld.Config.PIXELS_PER_TILE},pixelsToTiles:function(a){return Math.floor(a/Werld.Config.PIXELS_PER_TILE)},tilePointToPixelPoint:function(a){return _(a).map(this.tilesToPixels)},pixelPointToTilePoint:function(a){return _(a).map(this.pixelsToTiles)},pixelDistance:function(a,b){return Math.sqrt(Math.pow(a[0]-b[0],2)+Math.pow(a[1]-b[1],2))},tileDistance:function(a,b){return this.pixelsToTiles(this.pixelDistance(this.tilePointToPixelPoint(a),this.tilePointToPixelPoint(b)))}},Werld.Utils.Easel={bringDisplayObjectToFront:function(a){a.parent.sortChildren(function(b,c){return b===a?1:0})}},Werld.Utils.Math={randomBetween:function(a){return Math.random()*(a[1]-a[0]+1)+a[0]},randomIntegerBetween:function(a){return Math.floor(this.randomBetween(a))},toDecimal:function(a,b){return Number(a.toFixed(b))}},Werld.Utils.Callback={run:function(a){if(a instanceof Function)return a.apply(null,Array.prototype.slice.call(_(arguments).toArray(),1))}},Werld.Utils.Interval={set:function(a,b,c,d){a[b]=setInterval(c,d)},clear:function(a,b){clearInterval(a[b]),a[b]=null},install:function(a,b){_.chain(a).keys().each(function(c){Werld.Utils.Interval.set(b,c+"IntervalId",_(b[c]).bind(b),a[c])})},uninstall:function(a,b){_.chain(a).keys().each(function(a){Werld.Utils.Interval.clear(b,a+"IntervalId")})}},Werld.Utils.Circle=function(a){if(!a.center||!a.radius)throw new Error("Circle must be initialized with a center point and a radius");a.measurement||(a.measurement="pixels");if(a.measurement==="pixels")this.center=a.center,this.radius=a.radius;else if(a.measurement==="tiles")this.center=Werld.Utils.Geometry.tilePointToPixelPoint(a.center),this.radius=Werld.Utils.Geometry.tilesToPixels(a.radius);else throw new Error("Unknown measurement "+this.measurement+" for Circle");this.pixelPointWithinArea=function(a){return Werld.Utils.Geometry.pixelDistance(this.center,a)<=this.radius},this.tilePointWithinArea=function(a){return this.pixelPointWithinArea(Werld.Utils.Geometry.tilePointToPixelPoint(a))},this.randomPixelPoint=function(){var a=Math.random()*2*Math.PI,b=Math.random()*this.radius;return[this.center[0]+b*Math.cos(a),this.center[1]+b*Math.sin(a)]},this.randomTilePoint=function(){var a=this.randomPixelPoint();return _(a).map(function(a){return Werld.Utils.Geometry.pixelsToTiles(a-a%Werld.Config.PIXELS_PER_TILE)})}},Werld.CREATURES={CHARACTER:{baseDamageRange:[1,4],baseAttackSpeed:5,MOVEMENT_SPEED:2,BOUNDARIES:{MAX_CRITICAL_HIT_CHANCE:20,MAX_DEXTERITY:125,MAX_STRENGHT:125,MAX_INTELLIGENCE:125},SPRITE:{SRC:"images/sprite_sheets/characters/mage.png",DIMENSIONS:[40,40],FREQUENCY:.25}},SILVER_BAT:{name:"a silver bat",MOVEMENT_SPEED:1,strength:15,dexterity:15,intelligence:10,wrestling:40,baseDamageRange:[2,5],baseAttackSpeed:6,BOUNDARIES:{MAX_CRITICAL_HIT_CHANCE:20,MAX_DEXTERITY:125,MAX_STRENGHT:125,MAX_INTELLIGENCE:125},ITEMS:{GOLD:[5,10]},SPRITE:{SRC:"images/sprite_sheets/creatures/silver_bat.png",DIMENSIONS:[40,40],FRAMES:4,FREQUENCY:.25}},WHITE_WOLF:{name:"a white wolf",MOVEMENT_SPEED:1,strength:30,dexterity:30,intelligence:10,wrestling:50,baseDamageRange:[5,10],baseAttackSpeed:5,BOUNDARIES:{MAX_CRITICAL_HIT_CHANCE:20,MAX_DEXTERITY:125,MAX_STRENGHT:125,MAX_INTELLIGENCE:125},ITEMS:{GOLD:[15,20]},SPRITE:{SRC:"images/sprite_sheets/creatures/white_wolf.png",DIMENSIONS:[48,48],FRAMES:4,FREQUENCY:.25}},FIRE_WOLF:{name:"a fire wolf",MOVEMENT_SPEED:1,strength:40,dexterity:50,intelligence:20,wrestling:60,baseDamageRange:[8,15],baseAttackSpeed:4,BOUNDARIES:{MAX_CRITICAL_HIT_CHANCE:20,MAX_DEXTERITY:125,MAX_STRENGHT:125,MAX_INTELLIGENCE:125},ITEMS:{GOLD:[30,50]},SPRITE:{SRC:"images/sprite_sheets/creatures/fire_wolf.png",DIMENSIONS:[48,53],FRAMES:4,FREQUENCY:.25}},LEVIATHAN:{name:"a leviathan",MOVEMENT_SPEED:1,strength:100,dexterity:100,intelligence:200,wrestling:90,baseDamageRange:[15,25],baseAttackSpeed:3,BOUNDARIES:{MAX_CRITICAL_HIT_CHANCE:20,MAX_DEXTERITY:125,MAX_STRENGHT:125,MAX_INTELLIGENCE:125},ITEMS:{GOLD:[300,400]},SPRITE:{SRC:"images/sprite_sheets/creatures/leviathan.png",DIMENSIONS:[96,96],FRAMES:4,FREQUENCY:.5}},BLUE_DRAGON:{name:"a blue dragon",MOVEMENT_SPEED:1,strength:200,dexterity:200,intelligence:200,wrestling:100,baseDamageRange:[20,30],baseAttackSpeed:2,BOUNDARIES:{MAX_CRITICAL_HIT_CHANCE:20,MAX_DEXTERITY:125,MAX_STRENGHT:125,MAX_INTELLIGENCE:125},ITEMS:{GOLD:[500,600]},SPRITE:{SRC:"images/sprite_sheets/creatures/blue_dragon.png",DIMENSIONS:[96,96],FRAMES:4,FREQUENCY:.5}}};